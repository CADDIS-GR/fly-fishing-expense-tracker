name: ì§€ì¶œ ìë™ ê¸°ë¡

on:
  issues:
    types: [opened, edited]

jobs:
  record-expense:
    if: contains(github.event.issue.labels.*.name, 'expense')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ì§€ì¶œ ë°ì´í„° íŒŒì‹± ë° ì €ì¥
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            
            // Issue ë³¸ë¬¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
            const body = issue.body;
            const itemMatch = body.match(/### í’ˆëª©\s*\n\s*(.+)/);
            const amountMatch = body.match(/### ê¸ˆì•¡\s*\n\s*(.+)/);
            const categoryMatch = body.match(/### ì¹´í…Œê³ ë¦¬\s*\n\s*(.+)/);
            const storeMatch = body.match(/### êµ¬ë§¤ì²˜\s*\n\s*(.+)/);
            const memoMatch = body.match(/### ë©”ëª¨ \(ì„ íƒ\)\s*\n\s*(.+)/);
            
            if (!itemMatch || !amountMatch || !categoryMatch) {
              console.log('í•„ìˆ˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            const item = itemMatch[1].trim();
            const amount = parseInt(amountMatch[1].trim().replace(/[^0-9]/g, ''));
            const category = categoryMatch[1].trim();
            const store = storeMatch ? storeMatch[1].trim() : '';
            const memo = memoMatch ? memoMatch[1].trim() : '';
            
            // ë‚ ì§œ ì •ë³´
            const date = new Date().toISOString().split('T')[0];
            
            // ìƒˆ ì§€ì¶œ í•­ëª©
            const newExpense = {
              id: issue.number,
              date: date,
              item: item,
              amount: amount,
              category: category,
              store: store,
              memo: memo,
              issue_url: issue.html_url
            };
            
            // ê¸°ì¡´ ë°ì´í„° ì½ê¸°
            let expenses = [];
            const dataPath = 'data/expenses.json';
            
            try {
              if (fs.existsSync(dataPath)) {
                const data = fs.readFileSync(dataPath, 'utf8');
                expenses = JSON.parse(data);
              }
            } catch (error) {
              console.log('ìƒˆ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.');
              expenses = [];
            }
            
            // ì¤‘ë³µ ì²´í¬ (ê°™ì€ Issue IDë©´ ì—…ë°ì´íŠ¸)
            const existingIndex = expenses.findIndex(e => e.id === issue.number);
            if (existingIndex >= 0) {
              expenses[existingIndex] = newExpense;
            } else {
              expenses.push(newExpense);
            }
            
            // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // data í´ë” ìƒì„±
            if (!fs.existsSync('data')) {
              fs.mkdirSync('data', { recursive: true });
            }
            
            // íŒŒì¼ ì €ì¥
            fs.writeFileSync(dataPath, JSON.stringify(expenses, null, 2));
            
            console.log('ì§€ì¶œ ê¸°ë¡ ì™„ë£Œ:', newExpense);
            
            // Issueì— í™•ì¸ ëŒ“ê¸€ ë‹¬ê¸°
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `âœ… ì§€ì¶œì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n` +
                    `- **í’ˆëª©**: ${item}\n` +
                    `- **ê¸ˆì•¡**: ${amount.toLocaleString('ko-KR')}ì›\n` +
                    `- **ì¹´í…Œê³ ë¦¬**: ${category}\n` +
                    `- **êµ¬ë§¤ì²˜**: ${store || 'ë¯¸ê¸°ì¬'}\n` +
                    `- **ë‚ ì§œ**: ${date}`
            });
      
      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add data/expenses.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ’° ì§€ì¶œ ê¸°ë¡ ì—…ë°ì´íŠ¸: Issue #${{ github.event.issue.number }}" && git push)
